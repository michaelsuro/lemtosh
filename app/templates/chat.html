{% extends "base.html" %}

{% block title %}Chat - Lemtosh{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="model-info">
            Using: <span id="current-model">Mistral 7B</span>
        </div>
    </div>

    <div class="chat-messages" id="chat-messages">
        <!-- Messages will be added here dynamically -->
    </div>

    <div class="chat-input-container">
        <form id="chat-form">
            <textarea 
                id="message-input" 
                placeholder="Type your message..." 
                rows="3"
                class="chat-input"
            ></textarea>
            <button type="submit" class="send-button">Send</button>
        </form>
    </div>
</div>

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 90vh;
        max-width: 1000px;
        margin: 0 auto;
    }

    .chat-header {
        padding: 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .chat-messages {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 1rem;
        border-radius: 8px;
        white-space: pre-wrap;
    }

    .user-message {
        align-self: flex-end;
        background-color: #007bff;
        color: white;
    }

    .assistant-message {
        align-self: flex-start;
        background-color: #f1f3f5;
        color: black;
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }

    #chat-form {
        display: flex;
        gap: 1rem;
    }

    .chat-input {
        flex-grow: 1;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        resize: none;
    }

    .send-button {
        padding: 0.5rem 1rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .send-button:hover {
        background-color: #0056b3;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');

    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(isUser ? 'user-message' : 'assistant-message');
        messageDiv.textContent = content;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessage(message, true);

        // Clear input
        messageInput.value = '';

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    message: message,
                    model: 'mistral-7b'
                })
            });

            const data = await response.json();
            if (response.ok) {
                addMessage(data.response);
            } else {
                addMessage('Error: ' + data.detail);
            }
        } catch (error) {
            console.error('Chat error:', error);
            addMessage('Error: Failed to send message');
        }
    });

    // Handle textarea Enter key
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}