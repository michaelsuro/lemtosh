{% extends "base.html" %}

{% block title %}Home - Lemtosh{% endblock %}

{% block content %}
<div class="navbar">
    <div class="model-selector">
        <label for="model-select">Model:</label>
        <select id="model-select" class="form-control">
        </select>
    </div>
    <div class="user-info">
        <span id="username-display"></span>
        <button onclick="logout()" class="btn btn-small">Logout</button>
    </div>
</div>

<div class="main-content">
    <button id="new-chat-btn" class="btn">Start New Chat</button>
    
    <div class="archives-section">
        <h2>Archives</h2>
        <div id="chat-list" class="chat-list">
            <!-- Chat history will be populated here -->
        </div>
    </div>
</div>

<style>
    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 2rem;
    }

    .model-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .model-selector select {
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .main-content {
        padding: 1rem;
    }

    #new-chat-btn {
        margin-bottom: 2rem;
        padding: 0.75rem 1.5rem;
    }

    .archives-section {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }

    .chat-list {
        margin-top: 1rem;
    }

    .btn-small {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* New styles for chat archives */
    .chat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .chat-item:hover {
        background-color: #e9ecef;
    }

    .chat-title {
        font-weight: 500;
    }

    .chat-date {
        color: #6c757d;
        font-size: 0.875rem;
    }

    .no-chats {
        text-align: center;
        color: #6c757d;
        padding: 2rem;
        font-style: italic;
    }
</style>

<script>
// Initialize available models and chat archives when page loads
document.addEventListener('DOMContentLoaded', async () => {
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/auth/login';
        return;
    }

    // Display username
    const username = localStorage.getItem('username');
    document.getElementById('username-display').textContent = username;

    // Load available models
    await loadAvailableModels();
    
    // Load chat archives
    await loadChatArchives();
});

// Function to load available models
async function loadAvailableModels() {
    try {
        const response = await fetch('/api/models', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        const models = await response.json();
        
        const select = document.getElementById('model-select');
        select.innerHTML = '';  // Clear existing options
        
        Object.entries(models).forEach(([id, config]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = config.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading models:', error);
    }
}

// Function to load chat archives
async function loadChatArchives() {
    try {
        const response = await fetch('/api/chats', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load chat archives');
        }

        const chats = await response.json();
        const chatList = document.getElementById('chat-list');
        
        if (chats.length === 0) {
            chatList.innerHTML = '<div class="no-chats">No chat history yet</div>';
            return;
        }

        chatList.innerHTML = chats
            .map(chat => `
                <div class="chat-item" onclick="openChat(${chat.id})">
                    <span class="chat-title">${chat.title}</span>
                    <span class="chat-date">${new Date(chat.updated_at).toLocaleString()}</span>
                </div>
            `)
            .join('');
    } catch (error) {
        console.error('Error loading chat archives:', error);
        document.getElementById('chat-list').innerHTML = 
            '<div class="no-chats">Error loading chat history</div>';
    }
}

// Function to handle opening a chat
function openChat(chatId) {
    window.location.href = `/chat?id=${chatId}`;
}

// Function to handle logout
function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('username');
    window.location.href = '/auth/login';
}

// Handle new chat button click
document.getElementById('new-chat-btn').addEventListener('click', () => {
    const selectedModel = document.getElementById('model-select').value;
    localStorage.setItem('selectedModel', selectedModel);
    window.location.href = '/chat';
});
</script>
{% endblock %}